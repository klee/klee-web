---

machine:
  services:
    - docker
    - rabbitmq-server
    
dependencies:
  pre:
    - sudo apt-get update -qq
    - sudo apt-get install -qq python-apt python-pycurl
    - sudo apt-get install aptitude -y
    - sudo ln -s /home/ubuntu/klee-web/ /titb
    - sudo pip install ansible
    - sudo pip install flake8
    - sudo pip install httpie
  cache_directories:
    - "~/docker"
  override:
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -t kleeweb/klee python/worker/klee
    - mkdir -p ~/docker; docker save kleeweb/klee > ~/docker/image.tar

test:
  pre:
    - echo $VAULT_PASSWORD > /home/ubuntu/.vault_password
  override:
    - flake8 --max-complexity 12 --exclude=*/migrations/* .
    - ansible-playbook -i localhost, --syntax-check --vault-password-file=/home/ubuntu/.vault_password provisioning/vagrant.yml
    - ansible-playbook -i localhost, --connection=local --vault-password-file=/home/ubuntu/.vault_password -e ci=yes provisioning/vagrant.yml
    - sleep 10; http --check-status http://localhost/ > /dev/null
    - (source /src/worker/env/bin/activate && cd /titb/python/ && /src/python_runner.sh python -m unittest discover -s worker/tests/ -p 'test_*.py')

deployment:
  staging:
    branch: master
    commands:
      - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < /titb/.dockercfg.template > ~/.dockercfg
      - docker push kleeweb/klee
      - ansible-playbook -i provisioning/hosts --vault-password-file=/home/ubuntu/.vault_password provisioning/deploy.yml

